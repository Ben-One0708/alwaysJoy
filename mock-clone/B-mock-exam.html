<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bçµ„é­”ç‹ç´šæ¨¡æ“¬è€ƒ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #ffffff;
            padding: 30px;
            text-align: center;
        }

        .quiz-box {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            display: inline-block;
            min-width: 600px;
            position: relative;
        }

        .question-header {
            text-align: left;
            font-size: 20px;
            color: red;
            font-weight: bold;
            position: absolute;
            top: 20px;
            left: 30px;
        }

        .timer {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 20px;
            font-weight: bold;
            color: #1a237e;
        }

        .question-content {
            margin-top: 40px;
            font-size: 24px;
        }

        .question-image {
            margin: 20px auto;
            width: 500px;
            max-width: 90%;
            height: auto;
            min-height: 350px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            font-size: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            padding: 10px;
        }

        .question-image img {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: contain;
            border-radius: 8px;
            display: block;
        }

        input[type="text"] {
            padding: 10px;
            width: 250px;
            font-size: 20px;
            text-align: center;
            margin-top: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 15px 5px;
            border: none;
            border-radius: 8px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }

        .feedback {
            margin-top: 15px;
            font-weight: bold;
            font-size: 18px;
        }

        .scoreboard {
            margin-top: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .correction-section {
            margin-top: 20px;
            text-align: left;
        }

        .correction-section h3 {
            margin-bottom: 10px;
            color: #1a237e;
        }

        .correction-item {
            margin-bottom: 18px;
            padding: 14px;
            border-radius: 10px;
            background: #f5f7ff;
            border: 1px solid #d0d7ff;
            display: grid;
            gap: 12px;
        }

        .correction-item label {
            font-weight: bold;
            display: block;
            margin-bottom: 6px;
        }

        .correction-item .hint {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        .correction-item .answer {
            font-size: 16px;
            color: #1a237e;
            font-weight: bold;
        }

        .correction-item .answer {
            font-size: 16px;
            color: #1a237e;
            font-weight: bold;
        }

        .correction-inputs {
            display: grid;
            gap: 8px;
        }

        .correction-inputs input[type="text"] {
            width: 100%;
            max-width: 320px;
            padding: 8px;
            font-size: 18px;
            text-transform: lowercase;
        }

        .correction-image {
            display: flex;
            justify-content: center;
        }

        .correction-image img {
            max-width: 300px;
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .correction-section button[type="submit"] {
            margin-top: 12px;
            align-self: flex-start;
        }

        .correction-section .note {
            font-size: 14px;
            color: #777;
            margin-bottom: 12px;
        }

        .correction-warning {
            display: inline-block;
            margin-left: 12px;
            color: #d32f2f;
            font-weight: 700;
            font-size: 14px;
        }

        .tab-tip {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 12px 0;
            padding: 12px 16px;
            color: #1a237e;
            background: rgba(232, 234, 246, 0.65);
            border: 1px dashed #3f51b5;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .key-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 14px;
            border: 2px solid #1a237e;
            border-radius: 8px;
            font-weight: bold;
            background: #ffffff;
            font-size: 15px;
            box-shadow: 0 3px 0 rgba(26, 35, 126, 0.2), 0 3px 6px rgba(26, 35, 126, 0.25);
            min-width: 64px;
        }

        .key-badge .icon {
            font-size: 14px;
            opacity: 0.75;
        }

        .tab-tip strong {
            color: #1a237e;
        }

        .plus-sign {
            font-size: 18px;
            font-weight: bold;
            color: #1a237e;
        }

        .tab-example {
            margin: 6px 0 14px;
            font-size: 14px;
            color: #333;
        }

        .answers {
            margin-top: 20px;
            text-align: left;
            font-size: 18px;
        }

        .nav-panel {
            margin-top: 20px;
        }

        select {
            font-size: 16px;
            padding: 5px 10px;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: #ff6b81;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            z-index: 999;
        }

        .back-button:hover {
            background-color: #ff4757;
        }
    </style>
</head>

<body>
    <button onclick="goToPage('home.html')" class="back-button">â† å›ä¸Šä¸€é </button>

    <div class="quiz-box">
        <div class="question-header" id="question-number"></div>
        <div class="timer" id="timer">å‰©é¤˜æ™‚é–“ 70:00</div>
        <div id="question-image" class="question-image"></div>
        <div class="question-content" id="question-text"></div>
        <input type="text" id="answer" placeholder="Your answer here" autocomplete="off" />
        <br />
        <button id="submitBtn" onclick="manualSubmit()">Submit</button>
        <div class="feedback" id="feedback"></div>
        <div class="scoreboard" id="scoreboard"></div>
        <div id="correctionSection" class="correction-section"></div>
        <div class="answers" id="answers" style="display: none;"></div>
        <div class="nav-panel">
            <label for="questionSelect">è·³é¡Œï¼š</label>
            <select id="questionSelect" onchange="jumpToQuestion()"></select>
        </div>
    </div>

    <script>
        // Bçµ„é­”ç‹ç´šæ¨¡æ“¬è€ƒ 1~100é¡Œ
        const questions = [
            // 1-30: çœ‹åœ–æ‹¼å­—
            { type: "çœ‹åœ–æ‹¼å­—", clue: "s_____________r", definition: "sticker", answer: "sticker", imagePath: "B-image2/1.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "e_____________t", definition: "elephant", answer: "elephant", imagePath: "B-image2/2.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "c_____________e", definition: "cupcake", answer: "cupcake", imagePath: "B-image2/3.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "s_____________y", definition: "sleepy", answer: "sleepy", imagePath: "B-image2/4.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "s_____________y", definition: "snowy", answer: "snowy", imagePath: "B-image2/5.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "b_____________k", definition: "bookmark", answer: "bookmark", imagePath: "B-image2/6.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "k_____________e", definition: "kite", answer: "kite", imagePath: "B-image2/7.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "h_____________t", definition: "helmet", answer: "helmet", imagePath: "B-image2/8.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "c_____________p", definition: "clap", answer: "clap", imagePath: "B-image2/9.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "h_____________t", definition: "hat", answer: "hat", imagePath: "B-image2/10.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "s_____________e", definition: "snake", answer: "snake", imagePath: "B-image2/11.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "z_____________a", definition: "zebra", answer: "zebra", imagePath: "B-image2/12.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "b_____________r", definition: "bear", answer: "bear", imagePath: "B-image2/13.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "b_____________m", definition: "broom", answer: "broom", imagePath: "B-image2/14.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "s_____________h", definition: "sandwich", answer: "sandwich", imagePath: "B-image2/15.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "f_____________n", definition: "fifteen", answer: "fifteen", imagePath: "B-image2/16.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "b_____________n", definition: "balloon", answer: "balloon", imagePath: "B-image2/17.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "l_____________n", definition: "lion", answer: "lion", imagePath: "B-image2/18.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "s_____________m", definition: "swim", answer: "swim", imagePath: "B-image2/19.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "h_____________d", definition: "hand", answer: "hand", imagePath: "B-image2/20.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "c_____________ks", definition: "chopsticks", answer: "chopsticks", imagePath: "B-image2/21.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "w_____________w", definition: "window", answer: "window", imagePath: "B-image2/22.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "r_____________d", definition: "read", answer: "read", imagePath: "B-image2/23.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "l_____________n", definition: "lemon", answer: "lemon", imagePath: "B-image2/24.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "m_____________n", definition: "magician", answer: "magician", imagePath: "B-image2/25.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "f_____________y", definition: "fly", answer: "fly", imagePath: "B-image2/26.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "n_____________e", definition: "nurse", answer: "nurse", imagePath: "B-image2/27.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "b_____________y", definition: "butterfly", answer: "butterfly", imagePath: "B-image2/28.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "j_____________t", definition: "jacket", answer: "jacket", imagePath: "B-image2/29.jpg" },
            { type: "çœ‹åœ–æ‹¼å­—", clue: "u_____________a", definition: "umbrella", answer: "umbrella", imagePath: "B-image2/30.jpg" },
            // 31-75: æ–‡æ„å­—å½™
            { type: "æ–‡æ„å­—å½™", clue: "Anna is not crying, but there are tears(çœ¼æ·š) in her e_____es.", definition: "eyes", answer: "eyes" },
            { type: "æ–‡æ„å­—å½™", clue: "Kenny has five pets: a dog, two cats, and two r_____its.", definition: "rabbits", answer: "rabbits" },
            { type: "æ–‡æ„å­—å½™", clue: "My sister is a cute g_____l.", definition: "girl", answer: "girl" },
            { type: "æ–‡æ„å­—å½™", clue: "My hat is blue, and your hat is y_____w.", definition: "yellow", answer: "yellow" },
            { type: "æ–‡æ„å­—å½™", clue: "We're not happy. We're s_____d.", definition: "sad", answer: "sad" },
            { type: "æ–‡æ„å­—å½™", clue: "Ann and Amy are good f_____ds. They study and play together.", definition: "friends", answer: "friends" },
            { type: "æ–‡æ„å­—å½™", clue: "There are many fl_____rs in the park.", definition: "flowers", answer: "flowers" },
            { type: "æ–‡æ„å­—å½™", clue: "I want l_____ps and chocolate bars. They are sweet (ç”œçš„).", definition: "lollipops", answer: "lollipops" },
            { type: "æ–‡æ„å­—å½™", clue: "The toy car is one t_____d dollars.", definition: "thousand", answer: "thousand" },
            { type: "æ–‡æ„å­—å½™", clue: "You are t_____d. Please go to bed.", definition: "tired", answer: "tired" },
            { type: "æ–‡æ„å­—å½™", clue: "Mom is cooking in the k_____n.", definition: "kitchen", answer: "kitchen" },
            { type: "æ–‡æ„å­—å½™", clue: "Peter is riding a s_____r to school.", definition: "scooter", answer: "scooter" },
            { type: "æ–‡æ„å­—å½™", clue: "Let's sing and d_____e together.", definition: "dance", answer: "dance" },
            { type: "æ–‡æ„å­—å½™", clue: "There are many b_____lies and bees at the park.", definition: "butterflies", answer: "butterflies" },
            { type: "æ–‡æ„å­—å½™", clue: "I like cakes, especially (ç‰¹åˆ¥æ˜¯) c_____te cake.", definition: "chocolate", answer: "chocolate" },
            { type: "æ–‡æ„å­—å½™", clue: "At the amusement park, many kids have b_____ns.", definition: "balloons", answer: "balloons" },
            { type: "æ–‡æ„å­—å½™", clue: "There are some boys b_____d the tree. They are playing.", definition: "behind", answer: "behind" },
            { type: "æ–‡æ„å­—å½™", clue: "An elephant has a long trunk (è±¡é¼») and two big e_____rs.", definition: "ears", answer: "ears" },
            { type: "æ–‡æ„å­—å½™", clue: "Jack has a f_____g. It is small and green.", definition: "frog", answer: "frog" },
            { type: "æ–‡æ„å­—å½™", clue: "Our dog is not weak. It is s_____g.", definition: "strong", answer: "strong" },
            { type: "æ–‡æ„å­—å½™", clue: "Meg likes s_____ries. They are red and sweet (ç”œçš„).", definition: "strawberries", answer: "strawberries" },
            { type: "æ–‡æ„å­—å½™", clue: "Mika is 120 c_____rs tall.", definition: "centimeters", answer: "centimeters" },
            { type: "æ–‡æ„å­—å½™", clue: "There are some kids playing at the p_____k.", definition: "park", answer: "park" },
            { type: "æ–‡æ„å­—å½™", clue: "There are twenty m_____ys at the zoo.", definition: "monkeys", answer: "monkeys" },
            { type: "æ–‡æ„å­—å½™", clue: "Let's put some f_____ts in the basket. Do you want an apple?", definition: "fruits", answer: "fruits" },
            { type: "æ–‡æ„å­—å½™", clue: "We can eat ice cream with (ç”¨) a s_____n.", definition: "spoon", answer: "spoon" },
            { type: "æ–‡æ„å­—å½™", clue: "Please take out your books, and put them on your d_____k.", definition: "desk", answer: "desk" },
            { type: "æ–‡æ„å­—å½™", clue: "It's ten o'_____k. Let's go to bed.", definition: "o'clock", answer: "o'clock" },
            { type: "æ–‡æ„å­—å½™", clue: "There are many animals(å‹•ç‰©) in the z_____o.", definition: "zoo", answer: "zoo" },
            { type: "æ–‡æ„å­—å½™", clue: "Paul has many c_____c books. He is reading now.", definition: "comic", answer: "comic" },
            { type: "æ–‡æ„å­—å½™", clue: "I have a lunchbox and a banana in my b_____k.", definition: "backpack", answer: "backpack" },
            { type: "æ–‡æ„å­—å½™", clue: "Don't sit on the desk. Sit on the c_____r, please.", definition: "chair", answer: "chair" },
            { type: "æ–‡æ„å­—å½™", clue: "Alex has a new b_____le. He can ride it to school.", definition: "bicycle", answer: "bicycle" },
            { type: "æ–‡æ„å­—å½™", clue: "My f_____r is a farmer. My mother is a teacher.", definition: "father", answer: "father" },
            { type: "æ–‡æ„å­—å½™", clue: "Kelly has a pen and an e_____r in her pencil case.", definition: "eraser", answer: "eraser" },
            { type: "æ–‡æ„å­—å½™", clue: "My father doesn't work on S_____ys and Sundays.", definition: "Saturdays", answer: "Saturdays" },
            { type: "æ–‡æ„å­—å½™", clue: "My uncle has many pigs and h_____es on his farm (è¾²å ´).", definition: "horses", answer: "horses" },
            { type: "æ–‡æ„å­—å½™", clue: "I have five pencils in my pencil c_____e.", definition: "case", answer: "case" },
            { type: "æ–‡æ„å­—å½™", clue: "My bag is not red. It is p_____k.", definition: "pink", answer: "pink" },
            { type: "æ–‡æ„å­—å½™", clue: "Diana is t_____l. She's 180 centimeters.", definition: "tall", answer: "tall" },
            { type: "æ–‡æ„å­—å½™", clue: "Sara has a p_____ot. It is green, and it can talk.", definition: "parrot", answer: "parrot" },
            { type: "æ–‡æ„å­—å½™", clue: "These boxes are e_____y. They're light.", definition: "empty", answer: "empty" },
            { type: "æ–‡æ„å­—å½™", clue: "They have cu_____es and chocolate bars on the desk.", definition: "cupcakes", answer: "cupcakes" },
            { type: "æ–‡æ„å­—å½™", clue: "Simon doesn't want a toy car. He wants a p_____le.", definition: "puzzle", answer: "puzzle" },
            { type: "æ–‡æ„å­—å½™", clue: "Can you h_____r that? Someone (æœ‰äºº) is crying.", definition: "hear", answer: "hear" },
            // 76-100: å°è©±å¡«ç©º
            { type: "å°è©±å¡«ç©º", clue: "A: What c____r do you like? B: I like red.", definition: "color", answer: "color" },
            { type: "å°è©±å¡«ç©º", clue: "A: I don't want pepper. Please pass the s_____t. B: Sure. Here you are.", definition: "salt", answer: "salt" },
            { type: "å°è©±å¡«ç©º", clue: "A: Who's that? B: That's my c_____n. Her name is Zoey.", definition: "cousin", answer: "cousin" },
            { type: "å°è©±å¡«ç©º", clue: "A: What time is it? B: It's n_____e o'clock.", definition: "nine", answer: "nine" },
            { type: "å°è©±å¡«ç©º", clue: "A: How old is James? B: He is el_____n years old.", definition: "eleven", answer: "eleven" },
            { type: "å°è©±å¡«ç©º", clue: "A: What day is it? B: It's Th_____y.", definition: "Thursday", answer: "Thursday" },
            { type: "å°è©±å¡«ç©º", clue: "A: I want a c_____r. B: Why? A: I can play games on it.", definition: "computer", answer: "computer" },
            { type: "å°è©±å¡«ç©º", clue: "A: Do you have a c_____a? B: Yes. We can take a picture.", definition: "camera", answer: "camera" },
            { type: "å°è©±å¡«ç©º", clue: "A: Can I have your c_____e number? B: Sure. It's 0987-654-321.", definition: "cellphone", answer: "cellphone" },
            { type: "å°è©±å¡«ç©º", clue: "A: How many p_____e are there? B: Twelve. There are six girls and six boys.", definition: "people", answer: "people" },
            { type: "å°è©±å¡«ç©º", clue: "A: Where is your teacher from? B: He's from E_____d.", definition: "England", answer: "England" },
            { type: "å°è©±å¡«ç©º", clue: "A: Can we eat in the m_____m? B: No, we can't.", definition: "museum", answer: "museum" },
            { type: "å°è©±å¡«ç©º", clue: "A: Are they going to school? B: No, they're not. They're going to the p_____d.", definition: "playground", answer: "playground" },
            { type: "å°è©±å¡«ç©º", clue: "A: What are you drinking? B: I'm drinking g_____e juice.", definition: "grape", answer: "grape" },
            { type: "å°è©±å¡«ç©º", clue: "A: Where are we? B: I don't know. Let's check (æŸ¥çœ‹) the m_____p.", definition: "map", answer: "map" },
            { type: "å°è©±å¡«ç©º", clue: "A: How old is your brother? B: He's e______t years old.", definition: "eight", answer: "eight" },
            { type: "å°è©±å¡«ç©º", clue: "A: It's hot (ç†±çš„). I want some ice c_____m. B: I want some, too.", definition: "cream", answer: "cream" },
            { type: "å°è©±å¡«ç©º", clue: "A: What are those? B: They're c_____ns. Let's draw a bear.", definition: "crayons", answer: "crayons" },
            { type: "å°è©±å¡«ç©º", clue: "A: How old is Betty? B: She's tw_____e years old.", definition: "twelve", answer: "twelve" },
            { type: "å°è©±å¡«ç©º", clue: "A: Do you have a pet(å¯µç‰©)? B: Yes. I have a d_____g.", definition: "dog", answer: "dog" },
            { type: "å°è©±å¡«ç©º", clue: "A: Do you like p_____as or apples? B: I like apples.", definition: "papayas", answer: "papayas" },
            { type: "å°è©±å¡«ç©º", clue: "A: Where is the chair? B: It's in front of the d_____r.", definition: "door", answer: "door" },
            { type: "å°è©±å¡«ç©º", clue: "A: How old is your sister? B: She is n_____n.", definition: "nineteen", answer: "nineteen" },
            { type: "å°è©±å¡«ç©º", clue: "A: Where is my book? B: It's u_____r the bed.", definition: "under", answer: "under" },
            { type: "å°è©±å¡«ç©º", clue: "A: How's the w_____r? B: It's rainy.", definition: "weather", answer: "weather" }
        ];

        let current = 0;
        let userAnswers = Array(questions.length).fill("");
        // æ£€æŸ¥æ˜¯å¦æ˜¯ä»»åŠ¡äºŒæ¨¡å¼ï¼ˆ20åˆ†é’Ÿï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const isQuest2 = urlParams.get('quest') === '2';
        const TOTAL_TIME_SECONDS = isQuest2 ? 20 * 60 : 70 * 60;
        let remainingSeconds = TOTAL_TIME_SECONDS;
        let timerInterval = null;
        let startTime = null;
        let timeUp = false;
        const REQUIRED_REWRITES = 3;
        let correctionEntries = {};
        let levelStart = 0;
        let levelEnd = 100;
        let currentLevel = null;

        window.onload = () => {
            // æ£€æŸ¥URLå‚æ•°ï¼Œç¡®å®šå…³å¡èŒƒå›´
            const urlParams = new URLSearchParams(window.location.search);
            const start = parseInt(urlParams.get('start')) || 0;
            const level = parseInt(urlParams.get('level')) || null;

            if (level && start >= 0) {
                // å…³å¡æ¨¡å¼
                levelStart = start;
                levelEnd = start + 25; // æ¯ä¸ªå…³å¡25é¢˜
                currentLevel = level;
                current = levelStart;
                // åªæ˜¾ç¤ºå½“å‰å…³å¡çš„é¢˜ç›®
                const select = document.getElementById("questionSelect");
                for (let i = levelStart; i < levelEnd && i < questions.length; i++) {
                    const option = document.createElement("option");
                    option.value = i;
                    option.text = `é¡Œç›® ${i + 1}`;
                    select.appendChild(option);
                }
            } else {
                // å®Œæ•´æ¨¡å¼
                const select = document.getElementById("questionSelect");
                questions.forEach((_, i) => {
                    const option = document.createElement("option");
                    option.value = i;
                    option.text = `é¡Œç›® ${i + 1}`;
                    select.appendChild(option);
                });
            }

            loadQuestion();
            startTime = Date.now();
            startTimer();
        };

        function goToPage(url) {
            window.location.href = url;
        }

        function manualSubmit() {
            saveAnswer();
            nextQuestion();
        }

        function loadQuestion() {
            const questionNum = current + 1;
            const levelInfo = currentLevel ? ` [é—œå¡ ${currentLevel}]` : '';
            document.getElementById("question-number").textContent = `${questionNum}. ${questions[current].type}${levelInfo}`;
            const currentQuestion = questions[current];

            // é¡¯ç¤ºç›¸é—œåœ–ç‰‡
            const imageElement = document.getElementById("question-image");
            const questionTextElement = document.getElementById("question-text");

            // å„ªå…ˆä½¿ç”¨å¯¦éš›åœ–ç‰‡æ–‡ä»¶ï¼ˆå¦‚æœæœ‰çš„è©±ï¼Œä¾‹å¦‚æ®µè½å¡«ç©ºé¡Œç›®ï¼‰
            if (currentQuestion.imagePath) {
                imageElement.innerHTML = `<img src="${currentQuestion.imagePath}" alt="Question image" onerror="this.style.display='none'; this.parentElement.style.display='none';" />`;
                imageElement.style.display = "flex";
                imageElement.style.background = "transparent";
                imageElement.style.justifyContent = "center";
                imageElement.style.alignItems = "center";
                // å°æ–¼æ®µè½å¡«ç©ºï¼Œå…ˆé¡¯ç¤ºåœ–ç‰‡ï¼Œå¾Œé¡¯ç¤ºå¡«ç©ºé¡Œç›®
                if (currentQuestion.type === "æ®µè½å¡«ç©º") {
                    questionTextElement.textContent = currentQuestion.clue;
                    questionTextElement.style.marginTop = "20px";
                } else {
                    questionTextElement.textContent = currentQuestion.clue;
                }
            } else {
                // æ²’æœ‰åœ–ç‰‡æ™‚éš±è—åœ–ç‰‡å…ƒç´ 
                imageElement.style.display = "none";
                questionTextElement.textContent = currentQuestion.clue;
            }

            document.getElementById("answer").value = userAnswers[current] || "";
            document.getElementById("feedback").textContent = "";
            document.getElementById("scoreboard").textContent = "";
            document.getElementById("answers").style.display = "none";
            document.getElementById("questionSelect").value = current;
            document.getElementById("answer").style.display = "inline-block";
            document.getElementById("submitBtn").style.display = "inline-block";
        }

        function saveAnswer() {
            const input = document.getElementById("answer").value.trim();
            userAnswers[current] = input;
        }

        function nextQuestion() {
            const maxIndex = currentLevel ? Math.min(levelEnd - 1, questions.length - 1) : questions.length - 1;
            if (current < maxIndex) {
                current++;
                loadQuestion();
            } else {
                showFinalResult();
            }
        }

        function jumpToQuestion() {
            saveAnswer();
            current = parseInt(document.getElementById("questionSelect").value);
            loadQuestion();
        }

        function showFinalResult() {
            const submitButton = document.getElementById("submitBtn");
            if (submitButton.style.display === "none") {
                return;
            }

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            remainingSeconds = Math.max(0, remainingSeconds);
            updateTimerDisplay();

            document.getElementById("question-number").textContent = timeUp ? "â° æ™‚é–“åˆ°ï¼" : "ğŸ‰ å…¨éƒ¨å®Œæˆï¼";
            document.getElementById("question-text").textContent = "";
            document.getElementById("answer").style.display = "none";
            submitButton.style.display = "none";
            const feedbackEl = document.getElementById("feedback");
            feedbackEl.textContent = timeUp ? "æ™‚é–“åˆ°ï¼" : "";

            // è®¡ç®—åˆ†æ•°ï¼ˆåªè®¡ç®—å½“å‰å…³å¡èŒƒå›´å†…çš„é¢˜ç›®ï¼‰
            const scoreStartIdx = currentLevel ? levelStart : 0;
            const scoreEndIdx = currentLevel ? Math.min(levelEnd, questions.length) : questions.length;
            const scoreLevelQuestions = questions.slice(scoreStartIdx, scoreEndIdx);
            const scoreLevelAnswers = userAnswers.slice(scoreStartIdx, scoreEndIdx);
            const score = scoreLevelAnswers.reduce((sum, ans, i) => sum + (ans === scoreLevelQuestions[i].answer ? 1 : 0), 0);
            const totalQuestions = scoreEndIdx - scoreStartIdx;

            const elapsedSeconds = startTime ? Math.min(TOTAL_TIME_SECONDS, Math.floor((Date.now() - startTime) / 1000)) : 0;
            const timeSuffix = timeUp ? "ï¼ˆæ™‚é–“åˆ°ï¼‰" : "";
            const levelInfo = currentLevel ? ` [é—œå¡ ${currentLevel}]` : '';
            document.getElementById("scoreboard").innerHTML = `Your Score: ${score} / ${totalQuestions}${levelInfo}<br>${getGrade(score, totalQuestions)}<br>èŠ±è²»æ™‚é–“ï¼š${formatElapsedTime(elapsedSeconds)}${timeSuffix}`;

            const incorrectIndices = getIncorrectIndices();

            // å¦‚æœæ˜¯ä»»åŠ¡äºŒæ¨¡å¼ï¼Œä¿å­˜é”™è¯¯è®°å½•ä¾›ä»»åŠ¡ä¸‰ä½¿ç”¨
            const urlParams = new URLSearchParams(window.location.search);
            const isQuest2 = urlParams.get('quest') === '2';
            if (isQuest2 && incorrectIndices.length > 0) {
                const errors = incorrectIndices.map(idx => ({
                    questionNum: idx + 1,
                    clue: questions[idx].clue,
                    correctAnswer: questions[idx].answer,
                    userAnswer: userAnswers[idx] || '',
                    definition: questions[idx].definition
                }));
                localStorage.setItem('bQuest2Errors', JSON.stringify(errors));
            } else if (isQuest2 && incorrectIndices.length === 0) {
                // å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œä¿å­˜ç©ºæ•°ç»„
                localStorage.setItem('bQuest2Errors', JSON.stringify([]));
            }

            renderCorrectionSection(incorrectIndices);

            const answerBox = document.getElementById("answers");
            answerBox.style.display = "block";
            const answerStartIdx = currentLevel ? levelStart : 0;
            const answerEndIdx = currentLevel ? Math.min(levelEnd, questions.length) : questions.length;
            const answerLevelQuestions = questions.slice(answerStartIdx, answerEndIdx);
            const answerLevelAnswers = userAnswers.slice(answerStartIdx, answerEndIdx);

            answerBox.innerHTML = "<h3>ğŸ§  æ­£ç¢ºç­”æ¡ˆï¼š</h3><ol>" +
                answerLevelQuestions.map((q, i) => {
                    const actualIdx = answerStartIdx + i;
                    const ua = answerLevelAnswers[i] || "(æœªä½œç­”)";
                    const ok = (answerLevelAnswers[i] || "") === q.answer;
                    return `<li><strong>é¡Œç›® ${actualIdx + 1}: ${q.clue}</strong>: ${q.definition}<br>
                      ä½ çš„ç­”æ¡ˆï¼š<strong>${ua}</strong> ${ok ? 'âœ…' : 'âŒ'}<br>
                      æ­£ç¢ºç­”æ¡ˆï¼š<strong>${q.answer}</strong></li><br>`;
                }).join("") + "</ol>";
        }

        function getGrade(score, total = questions.length) {
            const pct = (score / total) * 100;
            if (pct === 100) return "ğŸ“ Perfect! Great job!";
            if (pct >= 70) return "ğŸ‘ Good work!";
            return "ğŸ“ Keep practicing!";
        }

        function getIncorrectIndices() {
            const incorrect = [];
            const startIdx = currentLevel ? levelStart : 0;
            const endIdx = currentLevel ? Math.min(levelEnd, questions.length) : questions.length;

            for (let i = startIdx; i < endIdx; i++) {
                if ((userAnswers[i] || "") !== questions[i].answer) {
                    incorrect.push(i);
                }
            }
            return incorrect;
        }

        function renderCorrectionSection(incorrectIndices) {
            const section = document.getElementById("correctionSection");
            if (!section) return;

            if (incorrectIndices.length === 0) {
                section.innerHTML = "<p>ğŸ‰ å…¨éƒ¨ç­”å°æˆ–å·²å…¨éƒ¨è¨‚æ­£å®Œæˆï¼Œæ­å–œï¼</p>";
                return;
            }

            const fields = incorrectIndices.map((index) => {
                const question = questions[index];
                const currentEntries = correctionEntries[index] || Array(REQUIRED_REWRITES).fill("");
                const imageMarkup = question.imagePath
                    ? `<div class="correction-image"><img src="${question.imagePath}" alt="Question ${index + 1} image" onerror="this.style.display='none';" /></div>`
                    : "";
                const inputs = currentEntries.map((value, rewriteIdx) => `
                    <input type="text" id="correction-${index}-${rewriteIdx}" name="correction-${index}-${rewriteIdx}" value="${value}" autocomplete="off" />
                `).join("");

                return `
                    <div class="correction-item">
                        <label>${index + 1}. ${question.clue}</label>
                        ${imageMarkup}
                        <div class="hint">æç¤ºï¼š${question.definition}</div>
                        <div class="answer">æ­£ç¢ºç­”æ¡ˆï¼š${question.answer}</div>
                        <div class="correction-inputs">
                            ${inputs}
                        </div>
                    </div>
                `;
            }).join("");

            const shortcutTips = `
                <div class="tab-tip">
                    <span class="key-badge">Tab<span class="icon">â†¹</span></span>
                    <span>è¼¸å…¥å®Œæˆå¾ŒæŒ‰ä¸‹ <strong>éµç›¤ä¸Šçš„ Tab</strong>ï¼Œå¯å¿«é€Ÿè·³åˆ°ä¸‹ä¸€å€‹è¨‚æ­£æ¬„ä½ã€‚</span>
                </div>
                <div class="tab-tip">
                    <span class="key-badge">Shift<span class="icon">â‡§</span></span>
                    <span class="plus-sign">+</span>
                    <span class="key-badge">Tab<span class="icon">â†¹</span></span>
                    <span>æŒ‰ä¸‹ <strong>éµç›¤ä¸Šçš„ Shift + Tab</strong> å›ä¸Šä¸€æ ¼ï¼Œè¿…é€Ÿè¿”å›å‰ä¸€å€‹è¨‚æ­£æ¬„ä½ã€‚</span>
                </div>
                <div class="tab-example">ä¾‹ï¼šåœ¨ç¬¬ä¸€æ ¼è¼¸å…¥ç­”æ¡ˆ â†’ æŒ‰ Tab â†’ ç«‹åˆ»åˆ‡æ›åˆ°ç¬¬äºŒæ ¼ã€‚</div>
            `;

            section.innerHTML = `
                <h3>è¨‚æ­£å€</h3>
                <p class="note">è«‹å°‡æ¯ä¸€é¡Œçš„æ­£ç¢ºç­”æ¡ˆåœ¨ç©ºæ ¼ä¸­æŠ„å¯« ${REQUIRED_REWRITES} æ¬¡ã€‚å…¨éƒ¨è¨‚æ­£å®Œæˆå¾ŒæŒ‰ä¸‹ã€Œé€å‡ºè¨‚æ­£ã€ï¼Œæ‰æœƒå›åˆ°ä¸»ç•«é¢ã€‚</p>
                ${shortcutTips}
                <form id="correctionForm">
                    ${fields}
                    <button type="submit">é€å‡ºè¨‚æ­£</button>
                    <span class="correction-warning">â€» å…¨éƒ¨è¨‚æ­£å®Œæ‰å¯ä»¥é€å‡ºè¨‚æ­£</span>
                </form>
            `;

            document.getElementById("feedback").textContent = "è«‹å®Œæˆè¨‚æ­£å¾Œå†é€å‡ºã€‚";

            const correctionForm = document.getElementById("correctionForm");
            correctionForm.addEventListener("submit", handleCorrectionSubmit);
        }

        function handleCorrectionSubmit(event) {
            event.preventDefault();
            const feedbackEl = document.getElementById("feedback");

            const incorrectIndices = getIncorrectIndices();
            if (incorrectIndices.length === 0) {
                feedbackEl.textContent = "è¨‚æ­£å·²å®Œæˆï¼Œå°‡æ–¼ 1.5 ç§’å¾Œå›åˆ°ä»»å‹™æ›¸ã€‚";

                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»»åŠ¡äºŒæ¨¡å¼
                const urlParams = new URLSearchParams(window.location.search);
                const isQuest2 = urlParams.get('quest') === '2';

                if (isQuest2) {
                    // æ ‡è®°ä»»åŠ¡äºŒå®Œæˆ
                    const progress = JSON.parse(localStorage.getItem('bQuestProgress') || '{}');
                    progress.quest2 = true;
                    localStorage.setItem('bQuestProgress', JSON.stringify(progress));
                    setTimeout(() => {
                        goToPage('B-quest-book.html?completed=2');
                    }, 1500);
                } else if (currentLevel) {
                    // å¦‚æœæ˜¯å…³å¡æ¨¡å¼ï¼Œæ ‡è®°å…³å¡å®Œæˆ
                    const saved = localStorage.getItem('bMapProgress');
                    const progress = saved ? JSON.parse(saved) : {};
                    progress[currentLevel] = true;
                    localStorage.setItem('bMapProgress', JSON.stringify(progress));
                    setTimeout(() => {
                        goToPage(`B-map.html?completed=${currentLevel}`);
                    }, 1500);
                } else {
                    setTimeout(() => {
                        goToPage('home.html');
                    }, 1500);
                }
                return;
            }

            let allCorrected = true;

            incorrectIndices.forEach((index) => {
                const answer = questions[index].answer.trim().toLowerCase();
                const entries = [];
                for (let rewriteIdx = 0; rewriteIdx < REQUIRED_REWRITES; rewriteIdx++) {
                    const fieldName = `correction-${index}-${rewriteIdx}`;
                    const value = (event.target[fieldName]?.value || "").trim();
                    entries.push(value);
                }
                correctionEntries[index] = entries;

                const hasEmpty = entries.some((value) => value === "");
                const allMatch = entries.every((value) => value.toLowerCase() === answer);

                if (hasEmpty || !allMatch) {
                    allCorrected = false;
                } else {
                    userAnswers[index] = questions[index].answer;
                }
            });

            if (allCorrected) {
                feedbackEl.textContent = "è¨‚æ­£å·²å®Œæˆï¼Œå°‡æ–¼ 1.5 ç§’å¾Œå›åˆ°åœ°åœ–ã€‚";
                renderCorrectionSection(getIncorrectIndices());

                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»»åŠ¡äºŒæ¨¡å¼
                const urlParams = new URLSearchParams(window.location.search);
                const isQuest2 = urlParams.get('quest') === '2';

                if (isQuest2) {
                    // æ ‡è®°ä»»åŠ¡äºŒå®Œæˆ
                    const progress = JSON.parse(localStorage.getItem('bQuestProgress') || '{}');
                    progress.quest2 = true;
                    localStorage.setItem('bQuestProgress', JSON.stringify(progress));
                    setTimeout(() => {
                        goToPage('B-quest-book.html?completed=2');
                    }, 1500);
                } else if (currentLevel) {
                    // å¦‚æœæ˜¯å…³å¡æ¨¡å¼ï¼Œæ ‡è®°å…³å¡å®Œæˆ
                    const saved = localStorage.getItem('bMapProgress');
                    const progress = saved ? JSON.parse(saved) : {};
                    progress[currentLevel] = true;
                    localStorage.setItem('bMapProgress', JSON.stringify(progress));
                    setTimeout(() => {
                        goToPage(`B-map.html?completed=${currentLevel}`);
                    }, 1500);
                } else {
                    setTimeout(() => {
                        goToPage('home.html');
                    }, 1500);
                }
            } else {
                feedbackEl.textContent = "è«‹ç¢ºèªæ¯ä¸€é¡Œéƒ½å·²æ­£ç¢ºæŠ„å¯«ä¸‰æ¬¡å¾Œå†é€å‡ºã€‚";
                renderCorrectionSection(getIncorrectIndices());
            }
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                remainingSeconds--;
                if (remainingSeconds <= 0) {
                    remainingSeconds = 0;
                    updateTimerDisplay();
                    clearInterval(timerInterval);
                    timerInterval = null;
                    timeUp = true;
                    saveAnswer();
                    showFinalResult();
                    return;
                }
                updateTimerDisplay();
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerElement = document.getElementById("timer");
            if (!timerElement) return;
            timerElement.textContent = `å‰©é¤˜æ™‚é–“ ${formatCountdown(remainingSeconds)}`;
        }

        function formatCountdown(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
        }

        function formatElapsedTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}åˆ†${String(secs).padStart(2, "0")}ç§’`;
        }

        document.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                saveAnswer();
                nextQuestion();
            }
        });
    </script>
</body>

</html>