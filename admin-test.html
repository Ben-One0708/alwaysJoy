<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .warning {
            background-color: #fff3cd;
            color: #856404;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”§ ç®¡ç†å“¡åŠŸèƒ½æ¸¬è©¦</h1>

        <div class="test-section info">
            <h3>ğŸ“‹ æ¸¬è©¦èªªæ˜</h3>
            <p>é€™å€‹é é¢æœƒæ¸¬è©¦ç®¡ç†å“¡åŠŸèƒ½ï¼ŒåŒ…æ‹¬æˆç¸¾è®€å–ã€çµ±è¨ˆå’Œé¡¯ç¤ºã€‚</p>
        </div>

        <div class="test-section">
            <h3>ğŸš€ åŸ·è¡Œæ¸¬è©¦</h3>
            <button onclick="testLoadScores()">æ¸¬è©¦è¼‰å…¥æˆç¸¾</button>
            <button onclick="testDisplayScores()">æ¸¬è©¦é¡¯ç¤ºæˆç¸¾</button>
            <button onclick="testAdminStats()">æ¸¬è©¦çµ±è¨ˆæ•¸æ“š</button>
            <button onclick="testRealTimeUpdate()">æ¸¬è©¦å¯¦æ™‚æ›´æ–°</button>
            <button onclick="runAllAdminTests()">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š çµ±è¨ˆæ•¸æ“š</h3>
            <div class="stats">
                <div class="stat-card">
                    <h4>ç¸½å­¸ç”Ÿæ•¸</h4>
                    <div class="stat-number" id="totalStudents">0</div>
                </div>
                <div class="stat-card">
                    <h4>ç¸½è¨˜éŒ„æ•¸</h4>
                    <div class="stat-number" id="totalRecords">0</div>
                </div>
                <div class="stat-card">
                    <h4>å¹³å‡åˆ†æ•¸</h4>
                    <div class="stat-number" id="averageScore">0</div>
                </div>
                <div class="stat-card">
                    <h4>ä»Šæ—¥æ–°å¢</h4>
                    <div class="stat-number" id="todayRecords">0</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æˆç¸¾è¨˜éŒ„</h3>
            <table id="scoresTable">
                <thead>
                    <tr>
                        <th>å­¸ç”Ÿå§“å</th>
                        <th>çµ„åˆ¥</th>
                        <th>ç·´ç¿’é¡å‹</th>
                        <th>åˆ†æ•¸</th>
                        <th>æ—¥æœŸ</th>
                        <th>å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="scoresTableBody">
                    <tr>
                        <td colspan="6" class="loading">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="results"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

    <!-- Firebase API å®¢æˆ¶ç«¯ -->
    <script src="api-firebase-client.js"></script>

    <script>
        const resultsDiv = document.getElementById('results');

        function addResult(title, content, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `
                <h4>${title}</h4>
                <pre>${content}</pre>
            `;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        // å­¸ç”Ÿè³‡æ–™ï¼ˆå¾ script.js è¤‡è£½ï¼‰
        const students = {
            'C2 Yuni': { group: 'Bçµ„', level: 'C2', password: 'Yuni', isAdmin: false },
            'C2 Emily': { group: 'Bçµ„', level: 'C2', password: 'Emily', isAdmin: false },
            'A8 Vito': { group: 'Bçµ„', level: 'A8', password: 'Vito', isAdmin: false },
            'A4 Eudora': { group: 'Cçµ„', level: 'A4', password: 'Eudora', isAdmin: false },
            'A5 Zoe': { group: 'Cçµ„', level: 'A5', password: 'Zoe', isAdmin: false },
            'N6 Bruce': { group: 'Dçµ„', level: 'N6', password: 'Bruce', isAdmin: false },
            'N7 Laura': { group: 'Dçµ„', level: 'N7', password: 'Laura', isAdmin: false },
            'K9 Lilian': { group: 'Eçµ„', level: 'K9', password: 'Lilian', isAdmin: false },
            'K9 Jill': { group: 'Eçµ„', level: 'K9', password: 'Jill', isAdmin: false },
            'I2 Candy': { group: 'Fçµ„', level: 'I2', password: 'Candy', isAdmin: false },
            'N3 Avery': { group: 'Fçµ„', level: 'N3', password: 'Avery', isAdmin: false },
            'æ•™å‹™çµ„ Annie': { group: 'æ•™å‹™çµ„', level: 'Admin', password: 'Annie', isAdmin: false },
            'æ•™å‹™çµ„ Celina': { group: 'æ•™å‹™çµ„', level: 'Admin', password: 'Celina', isAdmin: false },
            'æ•™å‹™çµ„ Nina': { group: 'æ•™å‹™çµ„', level: 'Admin', password: 'Nina', isAdmin: false },
            'Ben': { group: 'ç®¡ç†å“¡', level: 'Admin', password: 'BenBenBen', isAdmin: true }
        };

        // ç²å–å­¸ç”Ÿçµ„åˆ¥
        function getStudentGroup(studentName) {
            return students[studentName] ? students[studentName].group : 'æœªçŸ¥';
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW');
        }

        // é¡¯ç¤ºæˆç¸¾æ•¸æ“š
        function displayScores(scores) {
            const tbody = document.getElementById('scoresTableBody');

            if (!scores || scores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">æš«ç„¡æˆç¸¾è¨˜éŒ„</td></tr>';
                return;
            }

            tbody.innerHTML = scores.map(score => `
                <tr>
                    <td>${score.studentName || score.student_name}</td>
                    <td>${getStudentGroup(score.studentName || score.student_name)}</td>
                    <td>${score.quizType || score.quiz_type}</td>
                    <td>${score.score}</td>
                    <td>${formatDate(score.date)}</td>
                    <td>${score.notes || '-'}</td>
                </tr>
            `).join('');
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateAdminStats(scores) {
            const totalStudents = new Set(scores.map(s => s.studentName || s.student_name)).size;
            const totalRecords = scores.length;
            const averageScore = scores.length > 0 ?
                Math.round(scores.reduce((sum, s) => sum + s.score, 0) / scores.length) : 0;

            const today = new Date().toDateString();
            const todayRecords = scores.filter(s =>
                new Date(s.date).toDateString() === today
            ).length;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('averageScore').textContent = averageScore;
            document.getElementById('todayRecords').textContent = todayRecords;
        }

        async function testLoadScores() {
            clearResults();
            addResult('ğŸ”„ æ¸¬è©¦è¼‰å…¥æˆç¸¾', 'æ­£åœ¨å¾ Firebase è¼‰å…¥æˆç¸¾æ•¸æ“š...', 'info');

            try {
                if (window.apiService && typeof window.apiService.getAllScores === 'function') {
                    console.log('ä½¿ç”¨ Firebase è¼‰å…¥æˆç¸¾æ•¸æ“š');
                    const scores = await window.apiService.getAllScores();
                    console.log('è¼‰å…¥åˆ°çš„æˆç¸¾æ•¸æ“š:', scores);

                    addResult('âœ… è¼‰å…¥æˆç¸¾æˆåŠŸ',
                        `æˆåŠŸè¼‰å…¥ ${scores.length} ç­†æˆç¸¾è¨˜éŒ„\n\nè©³ç´°æ•¸æ“šï¼š\n${JSON.stringify(scores, null, 2)}`,
                        'success'
                    );

                    return scores;
                } else {
                    addResult('âŒ Firebase API ä¸å¯ç”¨', 'window.apiService æˆ– getAllScores æ–¹æ³•ä¸å­˜åœ¨', 'error');
                    return [];
                }
            } catch (error) {
                addResult('âŒ è¼‰å…¥æˆç¸¾å¤±æ•—', `éŒ¯èª¤è©³æƒ…ï¼š${error.message}`, 'error');
                return [];
            }
        }

        async function testDisplayScores() {
            addResult('ğŸ”„ æ¸¬è©¦é¡¯ç¤ºæˆç¸¾', 'æ­£åœ¨æ¸¬è©¦æˆç¸¾é¡¯ç¤ºåŠŸèƒ½...', 'info');

            try {
                const scores = await testLoadScores();
                displayScores(scores);
                updateAdminStats(scores);

                addResult('âœ… é¡¯ç¤ºæˆç¸¾æˆåŠŸ',
                    `å·²é¡¯ç¤º ${scores.length} ç­†æˆç¸¾è¨˜éŒ„\nçµ±è¨ˆæ•¸æ“šå·²æ›´æ–°`,
                    'success'
                );
            } catch (error) {
                addResult('âŒ é¡¯ç¤ºæˆç¸¾å¤±æ•—', `éŒ¯èª¤è©³æƒ…ï¼š${error.message}`, 'error');
            }
        }

        async function testAdminStats() {
            addResult('ğŸ”„ æ¸¬è©¦çµ±è¨ˆæ•¸æ“š', 'æ­£åœ¨æ¸¬è©¦ç®¡ç†å“¡çµ±è¨ˆåŠŸèƒ½...', 'info');

            try {
                const scores = await window.apiService.getAllScores();
                updateAdminStats(scores);

                const totalStudents = new Set(scores.map(s => s.studentName || s.student_name)).size;
                const totalRecords = scores.length;
                const averageScore = scores.length > 0 ?
                    Math.round(scores.reduce((sum, s) => sum + s.score, 0) / scores.length) : 0;

                addResult('âœ… çµ±è¨ˆæ•¸æ“šæ›´æ–°æˆåŠŸ',
                    `ç¸½å­¸ç”Ÿæ•¸ï¼š${totalStudents}\nç¸½è¨˜éŒ„æ•¸ï¼š${totalRecords}\nå¹³å‡åˆ†æ•¸ï¼š${averageScore}`,
                    'success'
                );
            } catch (error) {
                addResult('âŒ çµ±è¨ˆæ•¸æ“šæ›´æ–°å¤±æ•—', `éŒ¯èª¤è©³æƒ…ï¼š${error.message}`, 'error');
            }
        }

        async function testRealTimeUpdate() {
            addResult('ğŸ”„ æ¸¬è©¦å¯¦æ™‚æ›´æ–°', 'æ­£åœ¨æ¸¬è©¦å¯¦æ™‚æ•¸æ“šæ›´æ–°...', 'info');

            try {
                // æ¨¡æ“¬æ·»åŠ æ–°æˆç¸¾
                const testScore = {
                    studentName: 'æ¸¬è©¦å­¸ç”Ÿ',
                    quizType: 'æ¸¬è©¦ç·´ç¿’',
                    score: 85,
                    date: new Date().toISOString(),
                    notes: 'å¯¦æ™‚æ›´æ–°æ¸¬è©¦'
                };

                // ä¿å­˜æ¸¬è©¦æˆç¸¾
                const result = await window.apiService.saveScore(
                    testScore.studentName,
                    'æ¸¬è©¦çµ„',
                    testScore.quizType,
                    testScore.score
                );

                if (result.success) {
                    addResult('âœ… å¯¦æ™‚æ›´æ–°æ¸¬è©¦æˆåŠŸ',
                        `æ¸¬è©¦æˆç¸¾å·²ä¿å­˜ï¼š${JSON.stringify(result.score, null, 2)}`,
                        'success'
                    );

                    // é‡æ–°è¼‰å…¥æ•¸æ“š
                    setTimeout(async () => {
                        const scores = await window.apiService.getAllScores();
                        displayScores(scores);
                        updateAdminStats(scores);
                        addResult('âœ… æ•¸æ“šé‡æ–°è¼‰å…¥æˆåŠŸ',
                            `é‡æ–°è¼‰å…¥å¾Œå…±æœ‰ ${scores.length} ç­†è¨˜éŒ„`,
                            'success'
                        );
                    }, 1000);
                } else {
                    addResult('âŒ å¯¦æ™‚æ›´æ–°æ¸¬è©¦å¤±æ•—', `ä¿å­˜å¤±æ•—ï¼š${result.message}`, 'error');
                }
            } catch (error) {
                addResult('âŒ å¯¦æ™‚æ›´æ–°æ¸¬è©¦å¤±æ•—', `éŒ¯èª¤è©³æƒ…ï¼š${error.message}`, 'error');
            }
        }

        async function runAllAdminTests() {
            clearResults();
            addResult('ğŸš€ é–‹å§‹åŸ·è¡Œæ‰€æœ‰ç®¡ç†å“¡åŠŸèƒ½æ¸¬è©¦', 'æ­£åœ¨åŸ·è¡Œå®Œæ•´æ¸¬è©¦...', 'info');

            // æ¸¬è©¦ 1ï¼šè¼‰å…¥æˆç¸¾
            await testLoadScores();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // æ¸¬è©¦ 2ï¼šé¡¯ç¤ºæˆç¸¾
            await testDisplayScores();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // æ¸¬è©¦ 3ï¼šçµ±è¨ˆæ•¸æ“š
            await testAdminStats();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // æ¸¬è©¦ 4ï¼šå¯¦æ™‚æ›´æ–°
            await testRealTimeUpdate();

            addResult('ğŸ‰ æ‰€æœ‰ç®¡ç†å“¡åŠŸèƒ½æ¸¬è©¦å®Œæˆ', 'è«‹æŸ¥çœ‹ä¸Šé¢çš„æ¸¬è©¦çµæœ', 'success');
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        window.onload = function () {
            addResult('ğŸ“ ç®¡ç†å“¡åŠŸèƒ½æ¸¬è©¦æº–å‚™å°±ç·’', 'é é¢å·²è¼‰å…¥ï¼Œè«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦', 'info');
        };
    </script>
</body>

</html>