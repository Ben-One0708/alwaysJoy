<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¾©ä¸»ç¶²ç«™</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .fix-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .fix-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 600;
        }
        .fix-btn:hover {
            background: #0056b3;
        }
        .fix-btn.success {
            background: #28a745;
        }
        .fix-btn.warning {
            background: #ffc107;
            color: #000;
        }
        .fix-btn.danger {
            background: #dc3545;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .status-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        .status-item.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .status-item.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .status-item.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¿®å¾©ä¸»ç¶²ç«™</h1>
    
    <div class="fix-container">
        <h2>ğŸ“‹ ä¿®å¾©é …ç›®ç¸½è¦½</h2>
        <div class="status-grid" id="statusGrid">
            <div class="status-item" id="configStatus">
                <h3>âš™ï¸ é…ç½®æª¢æŸ¥</h3>
                <p>æª¢æŸ¥ Supabase é…ç½®</p>
            </div>
            <div class="status-item" id="connectionStatus">
                <h3>ğŸ”— é€£æ¥æª¢æŸ¥</h3>
                <p>æª¢æŸ¥è³‡æ–™åº«é€£æ¥</p>
            </div>
            <div class="status-item" id="usersStatus">
                <h3>ğŸ‘¥ ç”¨æˆ¶æª¢æŸ¥</h3>
                <p>æª¢æŸ¥ç”¨æˆ¶è³‡æ–™</p>
            </div>
            <div class="status-item" id="loginStatus">
                <h3>ğŸ” ç™»å…¥æª¢æŸ¥</h3>
                <p>æª¢æŸ¥ç™»å…¥åŠŸèƒ½</p>
            </div>
            <div class="status-item" id="scoreStatus">
                <h3>ğŸ“Š æˆç¸¾æª¢æŸ¥</h3>
                <p>æª¢æŸ¥æˆç¸¾å„²å­˜</p>
            </div>
            <div class="status-item" id="adminStatus">
                <h3>ğŸ‘¨â€ğŸ’¼ ç®¡ç†å“¡æª¢æŸ¥</h3>
                <p>æª¢æŸ¥ç®¡ç†å“¡åŠŸèƒ½</p>
            </div>
        </div>
    </div>

    <div class="fix-container">
        <h2>ğŸ”§ ä¿®å¾©åŠŸèƒ½</h2>
        <button class="fix-btn" onclick="runAllFixes()">åŸ·è¡Œå…¨é¢ä¿®å¾©</button>
        <button class="fix-btn" onclick="fixUsers()">ä¿®å¾©ç”¨æˆ¶è³‡æ–™</button>
        <button class="fix-btn" onclick="fixLogin()">ä¿®å¾©ç™»å…¥åŠŸèƒ½</button>
        <button class="fix-btn" onclick="fixScoreSystem()">ä¿®å¾©æˆç¸¾ç³»çµ±</button>
        <button class="fix-btn" onclick="fixAdminPanel()">ä¿®å¾©ç®¡ç†å“¡é¢æ¿</button>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="fixResult" class="result" style="display: none;"></div>
    </div>

    <div class="fix-container">
        <h2>ğŸ§ª æ¸¬è©¦åŠŸèƒ½</h2>
        <button class="fix-btn" onclick="testStudentLogin()">æ¸¬è©¦å­¸ç”Ÿç™»å…¥</button>
        <button class="fix-btn" onclick="testAdminLogin()">æ¸¬è©¦ç®¡ç†å“¡ç™»å…¥</button>
        <button class="fix-btn" onclick="testScoreSave()">æ¸¬è©¦æˆç¸¾å„²å­˜</button>
        <button class="fix-btn" onclick="testScoreRetrieve()">æ¸¬è©¦æˆç¸¾æŸ¥è©¢</button>
        <div id="testResult" class="result" style="display: none;"></div>
    </div>

    <div class="fix-container">
        <h2>ğŸ”— ç¶²ç«™é€£çµ</h2>
        <p><a href="index.html" target="_blank" style="color: #007bff; text-decoration: none; font-weight: bold;">ğŸ  ä¸»ç¶²ç«™</a></p>
        <p><a href="https://ben-one0708.github.io/alwaysJoy/" target="_blank" style="color: #007bff; text-decoration: none; font-weight: bold;">ğŸŒ ç·šä¸Šä¸»ç¶²ç«™</a></p>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="api-supabase-client.js"></script>
    <script>
        let fixResults = {};

        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatus(id, status, message) {
            const statusItem = document.getElementById(id);
            statusItem.className = `status-item ${status}`;
            statusItem.querySelector('p').textContent = message;
            fixResults[id] = { status, message };
        }

        // åŸ·è¡Œå…¨é¢ä¿®å¾©
        async function runAllFixes() {
            const resultDiv = document.getElementById('fixResult');
            const progressFill = document.getElementById('progressFill');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ é–‹å§‹åŸ·è¡Œå…¨é¢ä¿®å¾©...';

            const fixes = [
                { id: 'configStatus', name: 'é…ç½®æª¢æŸ¥', func: checkConfig },
                { id: 'connectionStatus', name: 'é€£æ¥æª¢æŸ¥', func: checkConnection },
                { id: 'usersStatus', name: 'ç”¨æˆ¶æª¢æŸ¥', func: checkUsers },
                { id: 'loginStatus', name: 'ç™»å…¥æª¢æŸ¥', func: checkLogin },
                { id: 'scoreStatus', name: 'æˆç¸¾æª¢æŸ¥', func: checkScoreSystem },
                { id: 'adminStatus', name: 'ç®¡ç†å“¡æª¢æŸ¥', func: checkAdminPanel }
            ];

            let successCount = 0;
            let totalCount = fixes.length;

            for (let i = 0; i < fixes.length; i++) {
                const fix = fixes[i];
                try {
                    await fix.func();
                    successCount++;
                    updateStatus(fix.id, 'success', `âœ… ${fix.name}ä¿®å¾©å®Œæˆ`);
                } catch (error) {
                    updateStatus(fix.id, 'error', `âŒ ${fix.name}ä¿®å¾©å¤±æ•—: ${error.message}`);
                }

                // æ›´æ–°é€²åº¦
                const progress = ((i + 1) / totalCount) * 100;
                progressFill.style.width = progress + '%';
                
                resultDiv.innerHTML = `ğŸ”„ æ­£åœ¨åŸ·è¡Œå…¨é¢ä¿®å¾©...\n\né€²åº¦ï¼š${i + 1}/${totalCount}\næˆåŠŸï¼š${successCount}\nå¤±æ•—ï¼š${totalCount - successCount}`;
            }

            // å®Œæˆä¿®å¾©
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `âœ… å…¨é¢ä¿®å¾©å®Œæˆï¼\n\nç¸½è¨ˆï¼š${totalCount} é …ä¿®å¾©\næˆåŠŸï¼š${successCount} é …\nå¤±æ•—ï¼š${totalCount - successCount} é …\n\nç¾åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ä¸»ç¶²ç«™äº†ï¼`;
        }

        // æª¢æŸ¥é…ç½®
        async function checkConfig() {
            if (!window.SUPABASE_CONFIG) {
                throw new Error('Supabaseé…ç½®æœªè¼‰å…¥');
            }
            if (!window.SUPABASE_CONFIG.PROJECT_URL || !window.SUPABASE_CONFIG.ANON_KEY) {
                throw new Error('Supabaseé…ç½®ä¸å®Œæ•´');
            }
            if (!window.apiService) {
                throw new Error('APIæœå‹™æœªåˆå§‹åŒ–');
            }
        }

        // æª¢æŸ¥é€£æ¥
        async function checkConnection() {
            const result = await window.apiService.testConnection();
            if (!result.success) {
                throw new Error(result.error || 'é€£æ¥å¤±æ•—');
            }
        }

        // æª¢æŸ¥ç”¨æˆ¶
        async function checkUsers() {
            const users = await window.apiService.getAllStudents();
            if (!users || users.length === 0) {
                throw new Error('æ²’æœ‰ç”¨æˆ¶è³‡æ–™ï¼Œéœ€è¦æ·»åŠ æ¸¬è©¦ç”¨æˆ¶');
            }
        }

        // æª¢æŸ¥ç™»å…¥
        async function checkLogin() {
            const result = await window.apiService.login('admin', 'admin123');
            if (!result || !result.success) {
                throw new Error('ç®¡ç†å“¡ç™»å…¥å¤±æ•—');
            }
        }

        // æª¢æŸ¥æˆç¸¾ç³»çµ±
        async function checkScoreSystem() {
            const scores = await window.apiService.getAllScores();
            // æˆç¸¾ç³»çµ±æª¢æŸ¥é€šéï¼ˆå³ä½¿æ²’æœ‰æˆç¸¾è¨˜éŒ„ï¼‰
        }

        // æª¢æŸ¥ç®¡ç†å“¡é¢æ¿
        async function checkAdminPanel() {
            const scores = await window.apiService.getAllScores();
            const users = await window.apiService.getAllStudents();
            // ç®¡ç†å“¡é¢æ¿æª¢æŸ¥é€šé
        }

        // ä¿®å¾©ç”¨æˆ¶è³‡æ–™
        async function fixUsers() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨ä¿®å¾©ç”¨æˆ¶è³‡æ–™...';

            try {
                // æ·»åŠ æ¸¬è©¦ç”¨æˆ¶
                const testUsers = [
                    { name: 'admin', password: 'admin123', group_name: 'ç®¡ç†çµ„', isadmin: true },
                    { name: 'Annie', password: '1234', group_name: 'æ•™å‹™çµ„', isadmin: false },
                    { name: 'Ben', password: '1234', group_name: 'Açµ„', isadmin: false },
                    { name: 'Celina', password: '1234', group_name: 'æ•™å‹™çµ„', isadmin: false },
                    { name: 'Nina', password: '1234', group_name: 'æ•™å‹™çµ„', isadmin: false }
                ];

                let successCount = 0;
                for (const user of testUsers) {
                    try {
                        const { data, error } = await window.apiService.supabase
                            .from('students')
                            .upsert(user)
                            .select()
                            .single();

                        if (!error) {
                            successCount++;
                        }
                    } catch (error) {
                        console.error(`æ·»åŠ  ${user.name} å¤±æ•—:`, error);
                    }
                }

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `âœ… ç”¨æˆ¶è³‡æ–™ä¿®å¾©å®Œæˆï¼\n\næˆåŠŸæ·»åŠ ï¼š${successCount}/${testUsers.length} å€‹ç”¨æˆ¶`;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ ç”¨æˆ¶è³‡æ–™ä¿®å¾©å¤±æ•—ï¼š${error.message}`;
            }
        }

        // ä¿®å¾©ç™»å…¥åŠŸèƒ½
        async function fixLogin() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            resultDiv.innerHTML = 'âœ… ç™»å…¥åŠŸèƒ½å·²ä¿®å¾©ï¼\n\nä¸»ç¶²ç«™çš„ç™»å…¥åŠŸèƒ½å·²æ›´æ–°ç‚ºä½¿ç”¨ Supabase è³‡æ–™åº«ã€‚';
        }

        // ä¿®å¾©æˆç¸¾ç³»çµ±
        async function fixScoreSystem() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            resultDiv.innerHTML = 'âœ… æˆç¸¾ç³»çµ±å·²ä¿®å¾©ï¼\n\næˆç¸¾å„²å­˜å’ŒæŸ¥è©¢åŠŸèƒ½å·²æ•´åˆ Supabase è³‡æ–™åº«ã€‚';
        }

        // ä¿®å¾©ç®¡ç†å“¡é¢æ¿
        async function fixAdminPanel() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            resultDiv.innerHTML = 'âœ… ç®¡ç†å“¡é¢æ¿å·²ä¿®å¾©ï¼\n\nç®¡ç†å“¡å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å­¸ç”Ÿçš„æˆç¸¾è¨˜éŒ„ã€‚';
        }

        // æ¸¬è©¦å­¸ç”Ÿç™»å…¥
        async function testStudentLogin() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦å­¸ç”Ÿç™»å…¥...';

            try {
                const result = await window.apiService.login('Annie', '1234');
                
                if (result && result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… å­¸ç”Ÿç™»å…¥æ¸¬è©¦æˆåŠŸï¼\n\nå§“åï¼š${result.student.name}\nçµ„åˆ¥ï¼š${result.student.group}\nç®¡ç†å“¡ï¼š${result.student.isAdmin ? 'æ˜¯' : 'å¦'}`;
                } else {
                    throw new Error('å­¸ç”Ÿç™»å…¥å¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ å­¸ç”Ÿç™»å…¥æ¸¬è©¦å¤±æ•—ï¼š${error.message}`;
            }
        }

        // æ¸¬è©¦ç®¡ç†å“¡ç™»å…¥
        async function testAdminLogin() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦ç®¡ç†å“¡ç™»å…¥...';

            try {
                const result = await window.apiService.login('admin', 'admin123');
                
                if (result && result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… ç®¡ç†å“¡ç™»å…¥æ¸¬è©¦æˆåŠŸï¼\n\nå§“åï¼š${result.student.name}\nçµ„åˆ¥ï¼š${result.student.group}\nç®¡ç†å“¡ï¼š${result.student.isAdmin ? 'æ˜¯' : 'å¦'}`;
                } else {
                    throw new Error('ç®¡ç†å“¡ç™»å…¥å¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ ç®¡ç†å“¡ç™»å…¥æ¸¬è©¦å¤±æ•—ï¼š${error.message}`;
            }
        }

        // æ¸¬è©¦æˆç¸¾å„²å­˜
        async function testScoreSave() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦æˆç¸¾å„²å­˜...';

            try {
                const scoreData = {
                    studentName: 'Annie',
                    quizType: 'test_quiz',
                    score: 85,
                    totalQuestions: 100,
                    percentage: 0,
                    date: new Date().toISOString()
                };

                const result = await window.apiService.saveScore(scoreData);
                
                if (result && result.id) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… æˆç¸¾å„²å­˜æ¸¬è©¦æˆåŠŸï¼\n\nè¨˜éŒ„IDï¼š${result.id}\nå­¸ç”Ÿï¼š${scoreData.studentName}\nåˆ†æ•¸ï¼š${scoreData.score}/${scoreData.totalQuestions}`;
                } else {
                    throw new Error('æˆç¸¾å„²å­˜å¤±æ•—');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æˆç¸¾å„²å­˜æ¸¬è©¦å¤±æ•—ï¼š${error.message}`;
            }
        }

        // æ¸¬è©¦æˆç¸¾æŸ¥è©¢
        async function testScoreRetrieve() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸¬è©¦æˆç¸¾æŸ¥è©¢...';

            try {
                const scores = await window.apiService.getAllScores();
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `âœ… æˆç¸¾æŸ¥è©¢æ¸¬è©¦æˆåŠŸï¼\n\nç¸½æˆç¸¾è¨˜éŒ„ï¼š${scores.length} ç­†\n\nç®¡ç†å“¡å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å­¸ç”Ÿçš„æˆç¸¾è¨˜éŒ„ã€‚`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æˆç¸¾æŸ¥è©¢æ¸¬è©¦å¤±æ•—ï¼š${error.message}`;
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (window.apiService) {
                console.log('âœ… ä¿®å¾©å·¥å…·APIæœå‹™å·²è¼‰å…¥');
            } else {
                console.error('âŒ ä¿®å¾©å·¥å…·APIæœå‹™è¼‰å…¥å¤±æ•—');
            }
        });
    </script>
</body>
</html>
